<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Destiny 2 Build Creator (Armor 3.0)</title>
  <style>
    :root{--bg:#0f1020;--card:#191a2e;--muted:#9aa3b2;--ok:#4ade80;--bad:#f87171;--accent:#60a5fa}
    *{box-sizing:border-box}
    body{background:var(--bg);color:#fff;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,Apple Color Emoji,Segoe UI Emoji;margin:0;padding:24px}
    h1{font-size:1.75rem;margin:0 0 8px}
    p{color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px;margin-top:16px}
    .card{background:var(--card);border:1px solid #2b2e55;border-radius:12px;padding:14px;box-shadow:0 2px 8px rgba(0,0,0,.35)}
    label{font-weight:700;display:block;margin-bottom:8px}
    input[type=range]{width:100%}
    .result{margin-top:16px;font-size:1.05rem}
    .ok{color:var(--ok)}.error{color:var(--bad)}
    .pieces{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:18px}
    .piece{background:#1f2140;border:1px solid #2e315e;border-radius:10px;padding:12px}
    .piece h3{margin:0 0 6px;font-size:1rem}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:.8rem;margin-right:6px;border:1px solid #3a3f7a}
    .small{font-size:.85rem;color:var(--muted)}
    .legend{display:flex;gap:6px;flex-wrap:wrap;margin:6px 0}
    .statline{display:flex;justify-content:space-between;font-variant-numeric:tabular-nums;align-items:center;margin-bottom:4px}
    .stat-mod{font-size:.8rem;color:var(--accent);margin-left:6px}
    .footer{margin-top:22px;color:var(--muted);font-size:.9rem}
    .cap{font-size:.9rem;color:var(--muted)}
  </style>
</head>
<body>
  <h1>Destiny 2 Build Creator — Armor 3.0</h1>
  <p class="small">Armor 3.0 with Masterwork (+5 to three lowest stats), minor/major stat mods (+5/+10, 1 per piece), and automatic tuning (+1 balanced or +5/-5 stat tuning) applied as required.</p>

  <div id="statsContainer" class="grid"></div>
  <div class="result"><p id="feasibility"></p></div>
  <div id="pieces" class="pieces"></div>
  <div class="footer small" id="notes"></div>

<script>
  const STATS = ["Super","Melee","Class","Grenade","Health","Weapons"];
  const ARCHETYPES = [
    {key:"Paragon", primary:"Super", secondary:"Melee"},
    {key:"Grenadier", primary:"Grenade", secondary:"Super"},
    {key:"Specialist", primary:"Class", secondary:"Weapons"},
    {key:"Brawler", primary:"Melee", secondary:"Health"},
    {key:"Bulwark", primary:"Health", secondary:"Class"},
    {key:"Gunner", primary:"Weapons", secondary:"Grenade"}
  ];

  let desired = Object.fromEntries(STATS.map(s=>[s,0]));

  function statObj(fill=0){const o={}; STATS.forEach(s=>o[s]=fill); return o;}
  const clone = o => JSON.parse(JSON.stringify(o));

  function pieceDistribution(archetype, tertiary){
    const dist = statObj(0);
    dist[archetype.primary]=30;
    dist[archetype.secondary]=25;
    dist[tertiary]=20;

    // Masterwork adds +5 to unused stats
    STATS.forEach(s=>{ if(s!==archetype.primary && s!==archetype.secondary && s!==tertiary) dist[s]+=5; });
    return dist;
  }

  function applyTuning(remaining, piece){
    // If deficit exists, apply +1 balanced tuning to three lowest stats
    let deficits = STATS.map(s=>remaining[s]-piece[s]).filter(d=>d>0);
    if(deficits.length){
      let sortedStats = STATS.map(s=>({s,val:piece[s]})).sort((a,b)=>a.val-b.val).slice(0,3);
      sortedStats.forEach(sobj=>{ piece[sobj.s]+=1; });
    }
    return piece;
  }

  function planPieces(target){
    let remaining = clone(target);
    let chosen=[];

    for(let i=0;i<5;i++){
      let best=null, bestScore=-Infinity;
      for(const arch of ARCHETYPES){
        const tertOptions = STATS.filter(s=>s!==arch.primary && s!==arch.secondary);
        for(const t of tertOptions){
          let piece = pieceDistribution(arch,t);
          piece = applyTuning(remaining, piece);
          let score=0; STATS.forEach(s=>{ score+=Math.min(piece[s], remaining[s]); });
          if(score>bestScore){ bestScore=score; best={arch, tertiary:t, piece}; }
        }
      }

      // Assign 1 stat mod per piece to highest remaining deficit stat, max 10
      let mod_assignment = STATS.map(s=>({stat:s,value:0}));
      let deficits = STATS.map(s=>({s,val:remaining[s]-best.piece[s]})).filter(d=>d>0);
      if(deficits.length){
        let top = deficits.reduce((a,b)=>a.val>b.val?a:b);
        mod_assignment.find(m=>m.stat===top.s).value = Math.min(10, top.val);
      }
      best.mod_assignment = mod_assignment;

      chosen.push(best);
      STATS.forEach(s=>{ remaining[s]-=(best.piece[s]+best.mod_assignment.find(m=>m.stat===s).value); if(remaining[s]<0) remaining[s]=0; });
    }
    return {chosen, remaining};
  }

  function renderSliders(){
    const wrap = document.getElementById('statsContainer'); wrap.innerHTML='';
    STATS.forEach(stat=>{
      const card=document.createElement('div'); card.className='card';
      const label=document.createElement('label'); label.textContent=stat;
      const slider=document.createElement('input'); slider.type='range'; slider.min=0; slider.max=200; slider.step=5; slider.value=desired[stat];
      const val=document.createElement('span'); val.className='small'; val.style.marginLeft='8px'; val.textContent=desired[stat];
      slider.addEventListener('input', e=>{ desired[stat]=parseInt(e.target.value,10); val.textContent=desired[stat]; recalc(); });
      card.append(label,slider,val); wrap.append(card);
    });
  }

  function recalc(){
    const piecesEl = document.getElementById('pieces'); piecesEl.innerHTML='';
    let plan = planPieces(desired);
    const still=plan.remaining; const unmet = STATS.filter(s=>still[s]>0 && desired[s]>0);
    if(unmet.length){ document.getElementById('feasibility').className='error'; document.getElementById('feasibility').textContent=`⚠️ Gear+mods plan leaves deficits: `+unmet.map(s=>`${s} ${still[s]}`).join(', '); document.getElementById('notes').textContent='Adjust desired stats.'; }
    else { document.getElementById('feasibility').className='ok'; document.getElementById('feasibility').textContent='✅ Achievable with gear, masterwork, tuning, and 1 stat mod per piece.'; document.getElementById('notes').textContent=''; }

    plan.chosen.forEach((c,idx)=>{
      const el=document.createElement('div'); el.className='piece';
      const header=document.createElement('h3'); header.textContent=`Piece ${idx+1}: ${c.arch.key}`;
      const legend=document.createElement('div'); legend.className='legend';
      legend.innerHTML=`<span class="pill">Primary: ${c.arch.primary} +30</span><span class="pill">Secondary: ${c.arch.secondary} +25</span><span class="pill">Tertiary: ${c.tertiary} +20</span>`;
      const table=document.createElement('div'); STATS.forEach(s=>{ 
        const row=document.createElement('div'); row.className='statline'; 
        const mod = c.mod_assignment.find(m=>m.stat===s && m.value>0);
        row.innerHTML=`<span>${s}: ${c.piece[s]}${mod?` (Stat Mod: +${mod.value})`:''}</span>`;
        table.appendChild(row);
      });
      el.append(header,legend,table); piecesEl.appendChild(el);
    });
  }

  renderSliders(); recalc();
</script>
</body>
</html>
